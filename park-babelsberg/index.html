<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Park Babelsberg Potsdam – Praktische Infos, Toiletten, Wege & Highlights</title>
<meta name="description" content="Alle praktischen Infos für deinen Besuch: Wo sind Toiletten? Welche Wege sind barrierefrei? Echte Bilder zeigen, was dich erwartet. Für Familien, Senioren, Hundebesitzer.">
<link rel="preload" href="images/park-babelsberg/jagdschloss.jpeg" as="image">

<!-- SEO Enhancements -->
<meta name="keywords" content="park babelsberg toiletten, wc park babelsberg, restaurants park babelsberg, parkplätze park babelsberg, neuer garten potsdam toiletten, schloss babelsberg gastronomie, potsdam park toiletten finden, park babelsberg karte">
<meta name="geo.region" content="DE-BB">
<meta name="geo.placename" content="Park Babelsberg, Potsdam">
<meta name="geo.position" content="52.400;13.085">
<link rel="canonical" href="https://example.com/park-babelsberg/index.html">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://example.com/park-babelsberg/index.html">
<meta property="og:title" content="Park Babelsberg Potsdam – Location-Finder für WCs & Restaurants">
<meta property="og:description" content="Interaktive Karte mit WCs, Restaurants und Parkplätzen im Park Babelsberg, Neuer Garten und Schloss Babelsberg. Mit Standort-Navigation.">
<meta property="og:image" content="https://example.com/park-babelsberg/images/park-babelsberg/jagdschloss.jpeg">
<meta property="og:locale" content="de_DE">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:url" content="https://example.com/park-babelsberg/index.html">
<meta name="twitter:title" content="Park Babelsberg Location-Finder">
<meta name="twitter:description" content="Finde WCs & Restaurants im Park Babelsberg mit unserer interaktiven Karte">
<meta name="twitter:image" content="https://example.com/park-babelsberg/images/park-babelsberg/jagdschloss.jpeg">

<link rel="stylesheet" href="assets/style.css">

<!-- DSGVO-konformes Cookie-Consent-Management -->
<!-- Google Analytics und AdSense werden nur nach Einwilligung geladen -->
<script src="assets/cookie-consent.js"></script>

<!-- Schema.org JSON-LD for Location Finder -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "TouristAttraction",
  "name": "Park Babelsberg",
  "description": "Historischer Landschaftspark in Potsdam mit Location-Finder für WCs, Restaurants und Parkplätze",
  "url": "https://example.com/park-babelsberg/index.html",
  "image": "https://example.com/park-babelsberg/images/park-babelsberg/jagdschloss.jpeg",
  "geo": {
    "@type": "GeoCoordinates",
    "latitude": "52.400",
    "longitude": "13.085"
  },
  "address": {
    "@type": "PostalAddress",
    "addressLocality": "Potsdam",
    "addressRegion": "Brandenburg",
    "addressCountry": "DE"
  },
  "amenityFeature": [
    {
      "@type": "LocationFeatureSpecification",
      "name": "WC-Finder",
      "value": "Interaktive Karte mit allen öffentlichen Toiletten im Park"
    },
    {
      "@type": "LocationFeatureSpecification",
      "name": "Gastronomie-Finder",
      "value": "Restaurants, Cafés und Imbisse in der Umgebung"
    },
    {
      "@type": "LocationFeatureSpecification",
      "name": "Parkplatz-Finder",
      "value": "Parkplätze für PKW und Fahrräder"
    }
  ],
  "hasMap": {
    "@type": "Map",
    "name": "Park Babelsberg Location-Finder",
    "url": "https://example.com/park-babelsberg/index.html#location-finder",
    "mapType": "VenueMap"
  }
}
</script>

</head>
<body>
<header class="header">
  <div class="hero" style="background-image: url('images/park-babelsberg/jagdschloss.jpeg')">
    <h1 style="font-size: clamp(2.5rem, 6vw, 4.5rem); line-height: 1.1;">Parks und Schlösser in Potsdam-Babelsberg <span style="font-size: clamp(1.25rem, 3vw, 2rem); display: block; margin-top: 1rem;">Kultur, Natur und Erholung am Ufer der Havel</span></h1>
  </div>
  <p class="lead">Eine Reise durch die UNESCO-Welterbe-Parks und Kulturdenkmäler am Ufer der Havel. Entdecken Sie die historischen Schlösser, Landschaftsgärten und ihre besonderen Merkmale – mit detaillierten Informationen zu Örtlichkeiten, Anfahrt, Öffnungszeiten und aktuellen Gegebenheiten vor Ort.</p>
  <nav class="nav" aria-label="Sprungmarken">
    <div class="badges">
      <a class="badge" href="#areale">Die 4 Areale</a>
      <a class="badge" href="#location-finder">Location-Finder</a>
      <a class="badge" href="#highlights">Highlights</a>
      <a class="badge" href="#praktisches">Praktisches</a>
      <a class="badge" href="#anreise">Anreise</a>
      <a class="badge" href="#faq">FAQ</a>
    </div>
  </nav>
</header>

<main id="content" data-page="park-babelsberg" data-date="2025-10-25">

  <!-- Die 4 Areale - Entdecke die schönsten Parks Potsdams -->
  <section id="areale" class="section" style="padding: var(--space-8) 0;">
    <h2 style="text-align: center; margin-bottom: var(--space-3);">Die 4 Areale – Eine Landschaft, vier Erlebnisse</h2>
    <p style="text-align: center; max-width: 800px; margin: 0 auto var(--space-8); color: var(--text-secondary);">
      Von der historischen Parkanlage bis zum königlichen Schloss – entdecke die verbundenen UNESCO-Welterbe-Areale am Ufer der Havel.
      Jeder Bereich hat seinen eigenen Charakter, seine eigene Geschichte und besondere Highlights.
    </p>

    <!-- Areal 1: Park Babelsberg -->
    <article id="park-babelsberg" class="section" style="margin-bottom: var(--space-10);">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-6); align-items: center;">
        <div>
          <span style="color: var(--accent-primary); font-weight: 600; text-transform: uppercase; font-size: 0.875rem; letter-spacing: 0.05em;">Areal 1</span>
          <h3 style="font-size: 2rem; margin: var(--space-2) 0 var(--space-3); font-family: var(--font-display);">Park Babelsberg</h3>
          <p style="color: var(--text-secondary); margin-bottom: var(--space-4); line-height: 1.7;">
            Der 124 Hektar große englische Landschaftspark am Ufer der Havel ist ein Meisterwerk der Gartenkunst.
            Seit 1990 UNESCO-Welterbe. Gestaltet von den legendären Landschaftsarchitekten Peter Joseph Lenné und Fürst Hermann von Pückler-Muskau.
          </p>
          <div style="margin-bottom: var(--space-3);">
            <strong style="color: var(--text-primary);">Besondere Highlights:</strong>
            <ul style="list-style: none; padding: 0; margin-top: var(--space-2);">
              <li style="padding: var(--space-1) 0;">→ <a href="uferweg-nord.html" style="color: var(--accent-primary);">Uferweg Nord</a> – Panoramablick über den Tiefen See</li>
              <li style="padding: var(--space-1) 0;">→ <a href="flatowturm.html" style="color: var(--accent-primary);">Flatowturm</a> – 46m Aussichtsturm mit 360°-Blick</li>
              <li style="padding: var(--space-1) 0;">→ <a href="matrosenhaus.html" style="color: var(--accent-primary);">Matrosenhaus</a> – Historisches Bootshaus am Havelufer</li>
              <li style="padding: var(--space-1) 0;">→ <a href="liegewiesen.html" style="color: var(--accent-primary);">Liegewiesen</a> – Entspannung mit Seeblick</li>
            </ul>
          </div>
          <a href="park-babelsberg.html" class="btn">Mehr über Park Babelsberg</a>
        </div>
        <div style="border-radius: var(--radius-xl); overflow: hidden; box-shadow: var(--shadow-lg);">
          <img src="images/park-babelsberg/eingang_park_babelsberg.jpeg" alt="Eingang Park Babelsberg" style="width: 100%; height: auto; display: block;">
        </div>
      </div>
    </article>

    <!-- Areal 2: Schloss Babelsberg -->
    <article id="schloss-babelsberg" class="section" style="margin-bottom: var(--space-10); background: var(--bg-tertiary); padding: var(--space-8); border-radius: var(--radius-xl);">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-6); align-items: center;">
        <div style="border-radius: var(--radius-xl); overflow: hidden; box-shadow: var(--shadow-lg);">
          <img src="images/park-babelsberg/schloss_garten.jpeg" alt="Schloss Babelsberg Garten" style="width: 100%; height: auto; display: block;">
        </div>
        <div>
          <span style="color: var(--accent-primary); font-weight: 600; text-transform: uppercase; font-size: 0.875rem; letter-spacing: 0.05em;">Areal 2</span>
          <h3 style="font-size: 2rem; margin: var(--space-2) 0 var(--space-3); font-family: var(--font-display);">Schloss Babelsberg</h3>
          <p style="color: var(--text-secondary); margin-bottom: var(--space-4); line-height: 1.7;">
            Das neugotische Sommerschloss von Kaiser Wilhelm I. thront majestätisch über der Havel.
            Erbaut 1833-1849 nach Entwürfen von Karl Friedrich Schinkel, Ludwig Persius und Johann Heinrich Strack.
          </p>
          <div style="margin-bottom: var(--space-3);">
            <strong style="color: var(--text-primary);">Besondere Highlights:</strong>
            <ul style="list-style: none; padding: 0; margin-top: var(--space-2);">
              <li style="padding: var(--space-1) 0;">→ <a href="schloss-babelsberg.html" style="color: var(--accent-primary);">Schloss Babelsberg</a> – Neugotische Architektur von Schinkel</li>
              <li style="padding: var(--space-1) 0;">→ <a href="schlosspark.html" style="color: var(--accent-primary);">Schlosspark</a> – Terrassengärten mit Aussicht</li>
              <li style="padding: var(--space-1) 0;">→ <a href="zypressen-allee.html" style="color: var(--accent-primary);">Zypressen-Allee</a> – Beeindruckende Baumallee</li>
            </ul>
          </div>
          <a href="schloss-babelsberg.html" class="btn">Mehr über Schloss Babelsberg</a>
        </div>
      </div>
    </article>

    <!-- Areal 3: Neuer Garten -->
    <article id="neuer-garten" class="section" style="margin-bottom: var(--space-10);">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-6); align-items: center;">
        <div>
          <span style="color: var(--accent-primary); font-weight: 600; text-transform: uppercase; font-size: 0.875rem; letter-spacing: 0.05em;">Areal 3</span>
          <h3 style="font-size: 2rem; margin: var(--space-2) 0 var(--space-3); font-family: var(--font-display);">Neuer Garten</h3>
          <p style="color: var(--text-secondary); margin-bottom: var(--space-4); line-height: 1.7;">
            Ein frühes Meisterwerk der Landschaftsgestaltung am Heiligen See. Angelegt ab 1787 für Friedrich Wilhelm II. im Stil englischer Gärten.
            Hier fand 1945 die Potsdamer Konferenz statt.
          </p>
          <div style="margin-bottom: var(--space-3);">
            <strong style="color: var(--text-primary);">Besondere Highlights:</strong>
            <ul style="list-style: none; padding: 0; margin-top: var(--space-2);">
              <li style="padding: var(--space-1) 0;">→ <a href="schloss-cecilienhof.html" style="color: var(--accent-primary);">Schloss Cecilienhof</a> – Ort der Potsdamer Konferenz 1945</li>
              <li style="padding: var(--space-1) 0;">→ <a href="marmorpalais.html" style="color: var(--accent-primary);">Marmorpalais</a> – Frühklassizistisches Schloss am See</li>
              <li style="padding: var(--space-1) 0;">→ <a href="heiliger-see.html" style="color: var(--accent-primary);">Heiliger See</a> – Idyllischer Rundweg mit Badestellen</li>
            </ul>
          </div>
          <a href="neuer-garten.html" class="btn">Mehr über Neuer Garten</a>
        </div>
        <div style="border-radius: var(--radius-xl); overflow: hidden; box-shadow: var(--shadow-lg);">
          <img src="images/park-babelsberg/cicilienhof.jpeg" alt="Schloss Cecilienhof im Neuen Garten" style="width: 100%; height: auto; display: block;">
        </div>
      </div>
    </article>

    <!-- Areal 4: Park Glienicke -->
    <article id="park-glienicke" class="section" style="margin-bottom: var(--space-10); background: var(--bg-tertiary); padding: var(--space-8); border-radius: var(--radius-xl);">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-6); align-items: center;">
        <div style="border-radius: var(--radius-xl); overflow: hidden; box-shadow: var(--shadow-lg);">
          <img src="images/park-babelsberg/jagdschloss.jpeg" alt="Jagdschloss Glienicke" style="width: 100%; height: auto; display: block;">
        </div>
        <div>
          <span style="color: var(--accent-primary); font-weight: 600; text-transform: uppercase; font-size: 0.875rem; letter-spacing: 0.05em;">Areal 4</span>
          <h3 style="font-size: 2rem; margin: var(--space-2) 0 var(--space-3); font-family: var(--font-display);">Park Glienicke</h3>
          <p style="color: var(--text-secondary); margin-bottom: var(--space-4); line-height: 1.7;">
            Der südlichste Teil der UNESCO-Welterbe-Landschaft an der Glienicker Brücke.
            Ein verstecktes Juwel mit italienisch inspirierter Architektur und romantischen Ausblicken über die Havel.
          </p>
          <div style="margin-bottom: var(--space-3);">
            <strong style="color: var(--text-primary);">Besondere Highlights:</strong>
            <ul style="list-style: none; padding: 0; margin-top: var(--space-2);">
              <li style="padding: var(--space-1) 0;">→ <a href="jagdschloss-glienicke.html" style="color: var(--accent-primary);">Jagdschloss Glienicke</a> – Klassizistisches Kleinod am Wasser</li>
              <li style="padding: var(--space-1) 0;">→ <a href="glienicker-bruecke.html" style="color: var(--accent-primary);">Glienicker Brücke</a> – Historische "Agentenbrücke"</li>
              <li style="padding: var(--space-1) 0;">→ <a href="park-glienicke.html" style="color: var(--accent-primary);">Parklandschaft</a> – Italienisch inspirierte Gartenkunst</li>
            </ul>
          </div>
          <a href="park-glienicke.html" class="btn">Mehr über Park Glienicke</a>
        </div>
      </div>
    </article>
  </section>

  <!-- Gastronomie Teaser -->
  <section class="section">
    <article class="card" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0; max-width: 100%;">
      <img src="images/park-babelsberg/Gastronomie.jpeg" alt="Gastronomie rund um Park Babelsberg" loading="lazy" style="aspect-ratio: 16/9; height: 100%; object-fit: cover;">
      <div style="padding: var(--space-5); display: flex; flex-direction: column; justify-content: center;">
        <h3 style="@apply heading-md; margin-bottom: var(--space-3);">Gastronomie in der Umgebung</h3>
        <p style="color: var(--text-secondary); margin-bottom: var(--space-4);">
          Von gehobener Küche bis zum schnellen Imbiss – entdecke alle Restaurants, Cafés und Imbisse
          in Fußnähe zum Park. Perfekt für die Einkehr nach deinem Parkbesuch.
        </p>
        <a href="gastronomie.html" class="btn" style="align-self: flex-start;">Alle Locations ansehen</a>
      </div>
    </article>
  </section>

  <!-- Parkplatz Teaser -->
  <section class="section" style="background: var(--bg-accent);">
    <article class="card" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0; max-width: 100%;">
      <div style="padding: var(--space-5); display: flex; flex-direction: column; justify-content: center;">
        <h3 style="@apply heading-md; margin-bottom: var(--space-3);">Parkplätze rund um den Park</h3>
        <p style="color: var(--text-secondary); margin-bottom: var(--space-4);">
          Über 1200 Parkplätze in der Umgebung – öffentlich und privat. Finde den nächsten freien Stellplatz
          und navigiere direkt mit dem Auto dorthin.
        </p>
        <a href="#anreise" class="btn" style="align-self: flex-start;">Zur Parkplatz-Info</a>
      </div>
      <img src="images/park-babelsberg/Parkplatz_schloss.jpeg" alt="Parkplätze am Park Babelsberg" loading="lazy" style="aspect-ratio: 16/9; height: 100%; object-fit: cover;">
    </article>
  </section>

  <!-- Highlights Section -->
  <section id="highlights" class="section">
    <h2>Die schönsten Orte rund um Schloss Babelsberg</h2>
    <p style="margin-bottom:20px;color:var(--muted)">Entdecke die historischen Bauwerke und landschaftlichen Highlights im UNESCO-Welterbe Park Babelsberg.</p>

    <div class="cards">
      <article class="card">
        <img src="images/park-babelsberg/attractions/schloss-babelsberg-1.webp" alt="Schloss Babelsberg" loading="lazy">
        <h3>Schloss Babelsberg</h3>
        <p>Neugotisches Sommerschloss von Kaiser Wilhelm I. Erbaut 1833-1849 von Schinkel, Persius und Strack. UNESCO-Welterbe seit 1990.</p>
        <a href="schloss-babelsberg.html" class="btn">Mehr erfahren</a>
      </article>

      <article class="card">
        <img src="images/park-babelsberg/attractions/flatowturm-1.webp" alt="Flatowturm" loading="lazy">
        <h3>Flatowturm</h3>
        <p>46m hoher Aussichtsturm mit 360°-Panorama über Potsdam. Erbaut 1853-1856. Geöffnet Mai–Oktober, Sa/So 10-17:30 Uhr.</p>
        <a href="flatowturm.html" class="btn">Mehr erfahren</a>
      </article>

      <article class="card">
        <img src="images/park-babelsberg/Uferweg_nord.jpeg" alt="Uferweg Nord – Blick über den Tiefen See" loading="lazy">
        <h3>Uferweg Nord</h3>
        <p>Malerischer Spazierweg mit freiem Panoramablick über den Tiefen See. Perfekt zum Entspannen, Fotografieren und Sonnenuntergang genießen.</p>
        <a href="uferweg-nord.html" class="btn">Mehr erfahren</a>
      </article>

      <article class="card">
        <img src="images/park-babelsberg/attractions/matrosenhaus-1.webp" alt="Matrosenhaus" loading="lazy">
        <h3>Matrosenhaus</h3>
        <p>Historisches Bootshaus am Havelufer aus dem 19. Jahrhundert. Heute Event-Location mit romantischem Blick aufs Wasser.</p>
      </article>

      <article class="card">
        <img src="images/park-babelsberg/park_babelsberg_zypressen_allee.webp" alt="Zypressen-Allee" loading="lazy">
        <h3>Zypressen-Allee</h3>
        <p>Beeindruckende Baumallee im Stil englischer Landschaftsgärten. Gestaltet von Lenné und Pückler-Muskau.</p>
      </article>

      <article class="card">
        <img src="images/park-babelsberg/liegewiesen.jpeg" alt="Liegewiesen im Park Babelsberg mit Sonnenstrahlen" loading="lazy">
        <h3>Liegewiesen</h3>
        <p>Weitläufige Grünflächen mit herrlichem Blick auf die Havel. Die Liegewiesen sind perfekt zum Entspannen, Picknicken und Sonnenbaden an warmen Tagen. Besonders am späten Nachmittag, wenn die Sonne durch die alten Bäume bricht, entsteht eine magische Atmosphäre. Die Wiesen bieten ausreichend Platz für Familien, Sportler und Ruhesuchende.</p>
      </article>
    </div>
  </section>

  <section id="praktisches" class="section">
    <h2>Praktisches vor Ort</h2>
    <p style="margin-bottom:20px;color:var(--muted)">Echte Bilder zeigen dir, was du vor Ort vorfindest. So kannst du deinen Besuch besser planen.</p>

    <div class="cards">
      <article class="card">
        <img src="images/park-babelsberg/info/wc.webp" alt="Toiletten im Park Babelsberg" loading="lazy">
        <h3>Toiletten</h3>
        <p>Öffentliche WCs sind ausgeschildert. Standorte an den Haupteingängen.</p>
        <a href="#location-finder" class="btn" onclick="setTimeout(() => { document.getElementById('filter-wc').click(); }, 100);">Auf Karte zeigen</a>
      </article>

      <article class="card">
        <img src="images/park-babelsberg/park_babelsberg_sitzgelegenheit_01.webp" alt="Sitzbänke im Park" loading="lazy">
        <h3>Sitzmöglichkeiten</h3>
        <p>Viele Bänke entlang der Wege. Ideal für Pausen mit Seeblick.</p>
        <a href="#location-finder" class="btn">Karte öffnen</a>
      </article>

      <article class="card">
        <img src="images/park-babelsberg/info/Wegweise_NeuerGarten.webp" alt="Wegweiser im Park" loading="lazy">
        <h3>Orientierung</h3>
        <p>Wegweiser führen zu Neuer Garten, Schloss und anderen Parks.</p>
        <a href="#location-finder" class="btn">Karte öffnen</a>
      </article>

      <article class="card">
        <img src="images/park-babelsberg/info/Schild_Spielplatz.webp" alt="Spielplatz-Hinweisschild" loading="lazy">
        <h3>Spielplatz</h3>
        <p>Ausgewiesener Spielplatz für Kinder. Folge der Beschilderung.</p>
        <a href="#location-finder" class="btn">Karte öffnen</a>
      </article>

      <article class="card">
        <img src="images/park-babelsberg/Parkordnung_Park_Babelsberg.jpeg" alt="Parkordnung Park Babelsberg" loading="lazy">
        <h3>Parkordnung</h3>
        <p>Detaillierte Regeln für Park Babelsberg und Neuer Garten im Vergleich. Was ist wo erlaubt?</p>
        <a href="parkordnung-vergleich.html" class="btn">Vergleich ansehen</a>
      </article>

      <article class="card">
        <img src="images/park-babelsberg/Schwimmen_verboten.jpeg" alt="Baden und Schwimmen verboten" loading="lazy">
        <h3>Baden verboten</h3>
        <p>Schwimmen in der Havel ist nicht erlaubt. Keine Badeaufsicht, Strömung, Schiffsverkehr. Alternative Badestellen in der Nähe.</p>
        <a href="#schwimmen-baden" class="btn">Alternativen anzeigen</a>
      </article>

      <article class="card">
        <img src="images/park-babelsberg/info/Schild_Fahrrad_Verboten02.webp" alt="Fahrrad-Regelung" loading="lazy">
        <h3>Fahrrad-Regelung</h3>
        <p>Auf manchen Wegen Radfahrverbot. Schilder vor Ort beachten.</p>
        <a href="#parkordnung-details" class="btn">Wege-Info anzeigen</a>
      </article>

      <article class="card">
        <img src="images/park-babelsberg/park_babelsberg_picknick_wiese.webp" alt="Picknick-Möglichkeiten" loading="lazy">
        <h3>Picknick</h3>
        <p>Große Wiesen laden zum Picknicken ein. Müll bitte mitnehmen.</p>
        <a href="#parkordnung-details" class="btn">Picknick-Regeln</a>
      </article>

      <article class="card">
        <img src="images/park-babelsberg/info/cafe-placeholder.webp" alt="Restaurants und Cafés" loading="lazy" style="object-fit:cover;">
        <h3>Gastronomie</h3>
        <p>303 Restaurants, Cafés und Eisdielen in der Nähe. Perfekt für eine Pause.</p>
        <a href="#location-finder" class="btn" onclick="setTimeout(() => { document.getElementById('filter-gastro').click(); }, 100);">Auf Karte zeigen</a>
      </article>

      <article class="card">
        <img src="images/park-babelsberg/info/parking-placeholder.webp" alt="Parkplätze" loading="lazy" style="object-fit:cover;">
        <h3>Parkplätze</h3>
        <p>Über 1200 Parkplätze rund um den Park. Öffentlich und privat.</p>
        <a href="#location-finder" class="btn" onclick="setTimeout(() => { document.getElementById('filter-parking').click(); }, 100);">Auf Karte zeigen</a>
      </article>

      <article class="card">
        <img src="images/park-babelsberg/info/vip-logo.png" alt="ViP Verkehrsbetrieb Potsdam - ÖPNV Haltestellen" loading="lazy" style="object-fit:contain; background: white; padding: var(--space-4);">
        <h3>ÖPNV</h3>
        <p>446 Bus- und Tram-Haltestellen mit Live-Abfahrten. Klimafreundlich anreisen.</p>
        <a href="#location-finder" class="btn" onclick="setTimeout(() => { document.getElementById('filter-oepnv').click(); }, 100);">Live-Fahrplan</a>
      </article>
    </div>
  </section>

  <!-- Anreise & Parkplätze -->
  <section id="anreise" class="section">
    <h2>Anreise & Parkplätze</h2>
    <p style="margin-bottom:20px;color:var(--muted);">
      So kommst du am besten zum Park Babelsberg – mit Auto, ÖPNV oder Fahrrad.
    </p>

    <div class="cards">
      <article class="card">
        <h3>Hauptparkplatz "Am Neuen Garten"</h3>
        <p>
          <strong>GPS:</strong> 52.419083, 13.071547<br>
          <strong>Adresse Navi:</strong> Am Neuen Garten, 14482 Potsdam<br>
          <strong>Kapazität:</strong> ca. 50 Stellplätze<br>
          <strong>Entfernung zum Schloss:</strong> 1,2 km (15 Min. Fußweg)
        </p>
        <p style="margin-top:12px;color:var(--text-muted);">
          Offizieller Parkplatz mit direktem Zugang zum Park.
          <strong style="color:var(--warning);">An Wochenenden oft voll ab 11 Uhr</strong> – früh kommen empfohlen!
        </p>
        <a href="#location-finder" class="btn" onclick="setTimeout(() => { document.getElementById('filter-parking').click(); }, 100);">Parkplätze auf Karte</a>
      </article>

      <article class="card">
        <h3>Alternative: Parkplatz Nord</h3>
        <p>
          <strong>GPS:</strong> 52.419706, 13.068494<br>
          <strong>Adresse Navi:</strong> Grenzstraße, 14482 Potsdam<br>
          <strong>Kapazität:</strong> ca. 20 Stellplätze (Straßenrand)<br>
          <strong>Entfernung zum Uferweg Nord:</strong> 200m (3 Min. Fußweg)
        </p>
        <p style="margin-top:12px;color:var(--text-muted);">
          Kleinerer Parkbereich nördlich des Parks. Perfekt für Besucher des Uferwegs Nord.
          <strong style="color:var(--success);">Meist weniger frequentiert</strong> als Hauptparkplatz.
        </p>
      </article>

      <article class="card">
        <h3>Mit ÖPNV (Empfohlen!)</h3>
        <p>
          <strong>Bus 694:</strong> Haltestelle "Park Babelsberg" (direkt am Eingang)<br>
          <strong>Bus 690:</strong> Haltestelle "Rathaus Babelsberg" (800m Fußweg)<br>
          <strong>Tram 93:</strong> Haltestelle "Lutherplatz" (1,2 km Fußweg)
        </p>
        <p style="margin-top:12px;color:var(--text-muted);">
          <strong style="color:var(--success);">Klimafreundlich und stressfrei</strong> – keine Parkplatzsuche!
          Live-Abfahrtszeiten auf unserer Karte verfügbar.
        </p>
        <a href="#location-finder" class="btn" onclick="setTimeout(() => { document.getElementById('filter-oepnv').click(); }, 100);">Live-Fahrplan</a>
      </article>

      <article class="card">
        <h3>Mit dem Fahrrad</h3>
        <p>
          <strong>Radweg:</strong> Über Glienicker Brücke & Haveluferweg<br>
          <strong>Fahrradparken:</strong> Abstellplätze am Haupteingang<br>
          <strong>Route von Potsdam HBF:</strong> 4,5 km (ca. 20 Min.)
        </p>
        <p style="margin-top:12px;color:var(--text-muted);">
          Schöne Radroute entlang der Havel.
          <strong>Achtung:</strong> Im Park nur auf asphaltierten Hauptwegen fahren – Wanderwege sind für Radfahrer verboten!
        </p>
      </article>
    </div>

    <div style="background:var(--bg-accent);padding:var(--space-4);border-radius:var(--radius-lg);margin-top:var(--space-3);">
      <h3 style="margin-top:0;">Parktipps für Autofahrer</h3>
      <div style="color:var(--text-secondary);line-height:1.8;">
        <p style="margin:0 0 12px 0;">
          <strong style="color:var(--accent);">Tipp 1:</strong> Wochenend-Besucher sollten vor 10 Uhr anreisen oder auf ÖPNV umsteigen.
        </p>
        <p style="margin:0 0 12px 0;">
          <strong style="color:var(--accent);">Tipp 2:</strong> Über 1200 weitere Parkplätze in der Umgebung (siehe Karte unten).
        </p>
        <p style="margin:0;">
          <strong style="color:var(--accent);">Tipp 3:</strong> Park + Ride: Parkplatz am S-Bahnhof Griebnitzsee (kostenlos), dann 15 Min. Fußweg.
        </p>
      </div>
    </div>
  </section>

  <!-- Detaillierte Parkordnung & Regeln -->
  <section id="parkordnung-details" class="section" style="background:var(--bg-accent);">
    <h2>Parkordnung & Regeln im Detail</h2>
    <p style="margin-bottom:24px;color:var(--muted)">
      Was ist erlaubt, was verboten? Hier findest du alle wichtigen Regeln für Park Babelsberg –
      mit Hinweisen, wo andere Parks in Potsdam mehr Freiheiten bieten.
    </p>

    <!-- Radfahren & Wege -->
    <div class="card" style="margin-bottom:24px;">
      <h3 style="margin-top:0;">Radfahren & Wege-Kategorien</h3>

      <div style="background:#ecfccb;border-left:4px solid #84cc16;padding:16px;margin-bottom:16px;border-radius:8px;">
        <strong style="color:#365314;">✓ Erlaubt: Asphaltierte Hauptwege</strong>
        <p style="margin:8px 0 0 0;color:#4d7c0f;">
          Radfahren ist auf den breiten, asphaltierten Hauptwegen erlaubt (z.B. vom Haupteingang zum Schloss,
          Allee parallel zur Havel). Diese Wege sind mit Fahrrad-Symbol gekennzeichnet.
        </p>
      </div>

      <div style="background:#fef3c7;border-left:4px solid #f59e0b;padding:16px;margin-bottom:16px;border-radius:8px;">
        <strong style="color:#78350f;">⚠ Nur Schieben: Wanderwege & Uferweg Nord</strong>
        <p style="margin:8px 0 0 0;color:#92400e;">
          Schmale Wanderwege (z.B. Uferweg Nord, Parkpfade zu Flatowturm) sind NUR für Fußgänger.
          Radfahrer müssen hier schieben oder werden abgemahnt.
        </p>
      </div>

      <div style="background:#fee2e2;border-left:4px solid #ef4444;padding:16px;margin-bottom:16px;border-radius:8px;">
        <strong style="color:#7f1d1d;">✗ Verboten: Historische Sichtachsen & Wiesen</strong>
        <p style="margin:8px 0 0 0;color:#991b1b;">
          Auf Liegewiesen, historischen Sichtachsen und Querwegen ist Radfahren strikt verboten.
          Bußgeld bis 55€.
        </p>
      </div>

      <details style="margin-top:16px;">
        <summary style="cursor:pointer;font-weight:600;color:var(--accent);">Wegekarte & Beschilderung</summary>
        <p style="margin-top:12px;color:var(--muted);">
          Vor Ort sind alle Wege mit Schildern gekennzeichnet. An Haupteingängen findest du Übersichtskarten
          mit farblicher Markierung: <strong style="color:#84cc16;">Grün = Radweg</strong>,
          <strong style="color:#f59e0b;">Orange = Fußweg</strong>,
          <strong style="color:#ef4444;">Rot = Verboten</strong>.
        </p>
      </details>
    </div>

    <!-- Drohnen & Fluggeräte -->
    <div class="card" style="margin-bottom:24px;">
      <h3 style="margin-top:0;">Drohnen & unbemannte Fluggeräte</h3>

      <div style="background:#fee2e2;border-left:4px solid #ef4444;padding:16px;margin-bottom:16px;border-radius:8px;">
        <strong style="color:#7f1d1d;">✗ Strikt verboten</strong>
        <p style="margin:8px 0 0 0;color:#991b1b;">
          Laut SPSG-Parkordnung sind <strong>unbemannte Luftfahrtsysteme (Drohnen, Modellflugzeuge)</strong>
          in allen Schlosspark-Anlagen verboten – auch mit Drohnenführerschein.
          <strong style="display:block;margin-top:8px;">Bußgeld bis 5.000€.</strong>
        </p>
      </div>

      <div style="background:#f3f4f6;border-left:4px solid #6b7280;padding:16px;border-radius:8px;">
        <strong style="color:#1f2937;">Warum das Verbot?</strong>
        <ul style="margin:8px 0 0 0;padding-left:20px;color:#4b5563;">
          <li>Schutz historischer Bausubstanz</li>
          <li>Vermeidung von Störungen bei Veranstaltungen</li>
          <li>Datenschutz & Privatsphäre von Besuchern</li>
          <li>Vogelschutz (Brutgebiete am Havelufer)</li>
        </ul>
      </div>

      <details style="margin-top:16px;">
        <summary style="cursor:pointer;font-weight:600;color:var(--accent);">Alternative Drohnen-Spots in Potsdam</summary>
        <p style="margin-top:12px;color:var(--muted);">
          <strong>Erlaubt (mit Einschränkungen):</strong><br>
          • Volkspark Potsdam (außerhalb Events, max. 120m Höhe)<br>
          • Templiner See Uferweg (außerhalb Naturschutzgebiete)<br>
          • Luftfahrtbehörde Potsdam informiert über aktuelle Flugzonen:
          <a href="https://www.dfs.de/dfs_homepage/de/" target="_blank" rel="noopener" style="color:var(--accent);">dfs.de</a>
        </p>
      </details>
    </div>

    <!-- Schwimmen & Baden -->
    <div id="schwimmen-baden" class="card" style="margin-bottom:24px;">
      <h3 style="margin-top:0;">Schwimmen & Baden</h3>

      <div style="background:#fee2e2;border-left:4px solid #ef4444;padding:16px;margin-bottom:16px;border-radius:8px;">
        <strong style="color:#7f1d1d;">✗ Offiziell verboten</strong>
        <p style="margin:8px 0 0 0;color:#991b1b;">
          Baden und Schwimmen ist im Park Babelsberg (Havel, Tiefer See) laut SPSG-Parkordnung verboten.
          Gründe: Keine Badeaufsicht, Strömung, Schiffsverkehr, Wasserqualität nicht getestet.
        </p>
      </div>

      <div style="background:#dbeafe;border-left:4px solid #3b82f6;padding:16px;border-radius:8px;">
        <strong style="color:#1e3a8a;">Geheimtipps & offizielle Badestellen</strong>
        <div style="margin-top:12px;color:#1e40af;">
          <p style="margin:0 0 12px 0;">
            <strong>1. Strandbad Babelsberg</strong> (ca. 1,5 km südlich)<br>
            Offizielles Freibad mit Sandstrand, Liegewiesen, DLRG-Aufsicht.
            <span style="color:#059669;">Mai–September geöffnet.</span><br>
            <a href="https://www.swp-potsdam.de/de/baeder/strandbad-babelsberg/" target="_blank" rel="noopener" style="color:var(--accent);">swp-potsdam.de</a>
          </p>

          <p style="margin:0 0 12px 0;">
            <strong>2. Havel-Nuthe-Wasserweg</strong> (wilder Zugang)<br>
            Lokale baden an der Havel südlich vom Park (außerhalb SPSG-Gelände).
            <span style="color:#dc2626;">⚠ Auf eigene Gefahr, keine Aufsicht.</span>
          </p>

          <p style="margin:0;">
            <strong>3. Heiliger See</strong> (Neuer Garten, 2 km nördlich)<br>
            Ebenfalls offiziell verboten, aber Anwohner nutzen Uferstellen.
            <span style="color:#dc2626;">⚠ Nicht empfohlen (häufige Kontrollen).</span>
          </p>
        </div>
      </div>
    </div>

    <!-- Picknick & Grillen -->
    <div class="card" style="margin-bottom:24px;">
      <h3 style="margin-top:0;">Picknick & Grillen</h3>

      <div style="background:#ecfccb;border-left:4px solid #84cc16;padding:16px;margin-bottom:16px;border-radius:8px;">
        <strong style="color:#365314;">✓ Picknick auf Liegewiesen</strong>
        <p style="margin:8px 0 0 0;color:#4d7c0f;">
          Picknicken ist auf den ausgewiesenen Liegewiesen erlaubt (große Wiese südlich vom Schloss,
          Uferbereiche mit Blick auf Havel). Bitte Müll mitnehmen – keine Mülleimer vor Ort.
        </p>
      </div>

      <div style="background:#fee2e2;border-left:4px solid #ef4444;padding:16px;margin-bottom:16px;border-radius:8px;">
        <strong style="color:#7f1d1d;">✗ Grillen & offenes Feuer verboten</strong>
        <p style="margin:8px 0 0 0;color:#991b1b;">
          Grillen, Lagerfeuer, Gaskocher sind im gesamten Park verboten (Brandschutz, Denkmalschutz).
          Bußgeld ab 150€. <strong style="display:block;margin-top:8px;">Tipp:</strong> Kaltes Picknick vorbereiten.
        </p>
      </div>

      <details style="margin-top:16px;">
        <summary style="cursor:pointer;font-weight:600;color:var(--accent);">Vergleich: Wo ist Grillen in Potsdam erlaubt?</summary>
        <p style="margin-top:12px;color:var(--muted);">
          <strong style="color:#84cc16;">✓ Volkspark Potsdam:</strong> Grillen auf ausgewiesenen Flächen erlaubt<br>
          <strong style="color:#84cc16;">✓ Templiner See Wiesen:</strong> Freies Grillen (außerhalb Naturschutz)<br>
          <strong style="color:#ef4444;">✗ Alle SPSG-Parks:</strong> Grillen verboten (Sanssouci, Babelsberg, Neuer Garten, Pfaueninsel)
        </p>
      </details>
    </div>

    <!-- Hunde -->
    <div class="card" style="margin-bottom:24px;">
      <h3 style="margin-top:0;">Hunde im Park</h3>

      <div style="background:#fef3c7;border-left:4px solid #f59e0b;padding:16px;margin-bottom:16px;border-radius:8px;">
        <strong style="color:#78350f;">⚠ Anleinpflicht</strong>
        <p style="margin:8px 0 0 0;color:#92400e;">
          Hunde sind im Park Babelsberg erlaubt, müssen aber an einer <strong>kurzen Leine</strong> geführt werden
          (max. 1,5 m). Freilauf ist verboten – auch für gut erzogene Hunde. Bußgeld ab 55€.
        </p>
      </div>

      <div style="background:#ecfccb;border-left:4px solid #84cc16;padding:16px;border-radius:8px;">
        <strong style="color:#365314;">✓ Hundekot-Beutel mitbringen</strong>
        <p style="margin:8px 0 0 0;color:#4d7c0f;">
          Kotbeutelspender gibt es nur an wenigen Eingängen. Bitte eigene Beutel mitbringen und Kot entfernen.
          Mülleimer befinden sich an Hauptwegen.
        </p>
      </div>

      <details style="margin-top:16px;">
        <summary style="cursor:pointer;font-weight:600;color:var(--accent);">Freilauf-Alternativen in Potsdam</summary>
        <p style="margin-top:12px;color:var(--muted);">
          <strong style="color:#84cc16;">✓ Hundeauslaufgebiet Volkspark:</strong> Eingezäunter Bereich für Freilauf<br>
          <strong style="color:#84cc16;">✓ Templiner See Uferwege:</strong> Freilauf in ausgewiesenen Zonen<br>
          <strong style="color:#84cc16;">✓ Ravensberge (Werder/Havel):</strong> Großes Freilauf-Areal, 15 Min. Fahrt
        </p>
      </details>
    </div>

    <!-- Weitere Regeln -->
    <div class="card">
      <h3 style="margin-top:0;">Weitere wichtige Regeln</h3>

      <div class="kv" style="gap:12px;">
        <div style="display:flex;align-items:start;gap:12px;">
          <span style="font-size:24px;">🏕️</span>
          <div>
            <strong>Camping & Zelten</strong>
            <span style="color:#ef4444;">Verboten</span> – auch Übernachten in Hängematten/Schlafsäcken
          </div>
        </div>

        <div style="display:flex;align-items:start;gap:12px;">
          <span style="font-size:24px;">🎵</span>
          <div>
            <strong>Musik & Lautsprecher</strong>
            <span style="color:#f59e0b;">Nur in Zimmerlautstärke</span> – Andere Besucher nicht stören
          </div>
        </div>

        <div style="display:flex;align-items:start;gap:12px;">
          <span style="font-size:24px;">⚽</span>
          <div>
            <strong>Ballsport & Frisbee</strong>
            <span style="color:#84cc16;">Auf Liegewiesen erlaubt</span> – Nicht an historischen Bauwerken
          </div>
        </div>

        <div style="display:flex;align-items:start;gap:12px;">
          <span style="font-size:24px;">🛴</span>
          <div>
            <strong>E-Scooter & Rollschuhe</strong>
            <span style="color:#f59e0b;">Schrittgeschwindigkeit</span> – Auf Hauptwegen erlaubt, nicht auf Wanderwegen
          </div>
        </div>

        <div style="display:flex;align-items:start;gap:12px;">
          <span style="font-size:24px;">🌳</span>
          <div>
            <strong>Pflanzenschutz</strong>
            <span style="color:#ef4444;">Nicht betreten</span> – Bepflanzte Bereiche & Blumenbeete sind tabu
          </div>
        </div>

        <div style="display:flex;align-items:start;gap:12px;">
          <span style="font-size:24px;">📸</span>
          <div>
            <strong>Fotografie & Filmen</strong>
            <span style="color:#84cc16;">Private Nutzung erlaubt</span> – Kommerzielle Shootings brauchen SPSG-Genehmigung
          </div>
        </div>
      </div>

      <div style="margin-top:20px;padding:16px;background:#f3f4f6;border-radius:8px;">
        <strong style="color:#1f2937;">Vollständige Parkordnung:</strong>
        <p style="margin:8px 0 0 0;color:#4b5563;">
          Die offizielle Parkordnung der SPSG ist an allen Eingängen ausgehängt und online verfügbar:<br>
          <a href="https://www.spsg.de/schloesser-gaerten/objekt/park-babelsberg/" target="_blank" rel="noopener" style="color:var(--accent);">
            spsg.de/park-babelsberg
          </a>
        </p>
      </div>
    </div>
  </section>

  <!-- WC-Finder Map Module -->
  <section id="wc-finder" class="section">
<!-- Unified Location-Finder Map Module -->
<!-- Integration: Ersetze die separaten Map-Sections in index.html mit diesem Block -->

<!-- Unified Location-Finder Map Module V2 -->
<!-- Optimized: Clustering, Hierarchical Filters, Mobile-First, Performance -->

<!-- Unified Location-Finder Map Module V3 -->
<!-- V3: + ÖPNV-Haltestellen (Bus & Tram) mit VBB-Link, prepared for Live-API -->

<!-- Unified Location-Finder Map Module V4 -->
<!-- V4: + Live-Fahrplandaten (VBB REST API v6) mit Echtzeit-Abfahrten -->

<section id="location-finder" class="section">
  <h2>Location-Finder für die Potsdamer Parklandschaft</h2>
  <p style="margin-bottom:16px;color:var(--text-muted)">
    Finde WCs, Restaurants, Parkplätze und ÖPNV-Haltestellen in allen 4 Bereichen:
    <strong>Park Babelsberg</strong>, <strong>Schloss Babelsberg</strong>, <strong>Neuer Garten</strong> und <strong>Park Glienicke</strong>.
    Mit Standort-Navigation und Live-Fahrplanauskünften.
  </p>

  <div class="card" style="padding:0;overflow:hidden;">
    <!-- Main Filter Buttons -->
    <div style="padding:16px;display:flex;gap:12px;flex-wrap:wrap;background:var(--bg-secondary);border-bottom:2px solid var(--border-color);">
      <button id="filter-wc" class="filter-btn active" data-layer="wc" aria-pressed="true">
        <span class="filter-icon">🚻</span> WC <span class="filter-count" id="count-wc">0</span>
      </button>
      <button id="filter-gastro" class="filter-btn active" data-layer="gastro" aria-pressed="true">
        <span class="filter-icon">🍽️</span> Gastronomie <span class="filter-count" id="count-gastro">0</span>
      </button>
      <button id="filter-parking" class="filter-btn" data-layer="parking" aria-pressed="false">
        <span class="filter-icon">🅿️</span> Parkplätze <span class="filter-count" id="count-parking">0</span>
      </button>
      <button id="filter-oepnv" class="filter-btn" data-layer="oepnv" aria-pressed="false">
        <span class="filter-icon">🚍</span> ÖPNV <span class="filter-count" id="count-oepnv">0</span>
      </button>
    </div>

    <!-- Sub-Filter für Gastronomie -->
    <div id="gastro-subfilter" class="subfilter-panel">
      <div style="padding:12px 16px;display:flex;gap:8px;flex-wrap:wrap;background:#fafafa;">
        <label class="subfilter-checkbox">
          <input type="checkbox" data-amenity="restaurant" checked> 🍽️ Restaurant
        </label>
        <label class="subfilter-checkbox">
          <input type="checkbox" data-amenity="cafe" checked> ☕ Café
        </label>
        <label class="subfilter-checkbox">
          <input type="checkbox" data-amenity="fast_food" checked> 🍔 Imbiss
        </label>
        <label class="subfilter-checkbox">
          <input type="checkbox" data-amenity="bar" checked> 🍺 Bar
        </label>
        <label class="subfilter-checkbox">
          <input type="checkbox" data-amenity="pub" checked> 🍺 Pub
        </label>
        <label class="subfilter-checkbox">
          <input type="checkbox" data-amenity="ice_cream" checked> 🍦 Eiscafé
        </label>
        <label class="subfilter-checkbox">
          <input type="checkbox" data-amenity="biergarten" checked> 🌳 Biergarten
        </label>
      </div>
    </div>

    <!-- Map Container -->
    <div id="unified-map" style="height:500px;width:100%;background:#e5e7eb;" role="application" aria-label="Interaktive Karte"></div>

    <!-- Controls -->
    <div style="padding:16px;display:flex;gap:12px;flex-wrap:wrap;align-items:center;background:white;">
      <button id="btn-locate" class="map-btn map-btn-primary" aria-label="Meinen Standort nutzen">
        📍 Standort nutzen
      </button>
      <button id="btn-nearest-wc" class="map-btn map-btn-secondary" disabled aria-label="Zum nächsten WC navigieren">
        🚻 Nächstes WC
      </button>
      <button id="btn-nearest-gastro" class="map-btn map-btn-secondary" disabled aria-label="Zum nächsten Restaurant navigieren">
        🍽️ Nächstes Restaurant
      </button>
      <button id="btn-nearest-parking" class="map-btn map-btn-secondary" disabled style="display:none;" aria-label="Zum nächsten Parkplatz navigieren">
        🅿️ Nächster Parkplatz
      </button>
    </div>

    <!-- Distance Info -->
    <div id="distance-info" style="padding:0 16px 12px;color:var(--text-muted);font-size:0.9rem;min-height:20px;" role="status" aria-live="polite"></div>

    <!-- Legend -->
    <details class="notice" style="margin:0 16px 16px;cursor:pointer;">
      <summary style="font-weight:600;padding:8px 0;">📍 Legende & Datenquellen</summary>
      <div style="padding-top:8px;font-size:0.9rem;line-height:1.6;">
        <strong>WC:</strong> 🟢 Öffentlich · 🟡 Nur Kunden · 💰 Kostenpflichtig<br>
        <strong>Gastronomie:</strong> 🍽️ Restaurant · ☕ Café · 🍔 Imbiss · 🍺 Bar/Pub · 🍦 Eiscafé · 🌳 Biergarten<br>
        <strong>Parkplätze:</strong> 🅿️ Öffentlich · 💰 Kostenpflichtig · 🔒 Privat · 🏢 Parkhaus · 🚲 Fahrrad<br>
        <strong>ÖPNV:</strong> 🚍 Bus & Tram Haltestellen · 🕐 Fahrplanauskünfte via VBB<br>
        <strong>Daten:</strong> © OpenStreetMap-Mitwirkende (ODbL) ·
        <strong>Navigation:</strong> Google Maps
      </div>
    </details>
  </div>
</section>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">

<!-- Leaflet MarkerCluster CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" crossorigin="anonymous">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" crossorigin="anonymous">

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>

<!-- Leaflet MarkerCluster JS -->
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js" crossorigin="anonymous"></script>

<!-- Styles -->
<style>
  /* Filter Buttons */
  .filter-btn {
    padding: 10px 16px;
    border: 2px solid #d1d5db;
    border-radius: 8px;
    background: white;
    color: #374151;
    font-family: var(--font-body);
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 6px;
    flex: 1 1 auto;
    min-width: 140px;
    justify-content: center;
  }

  .filter-btn .filter-icon {
    font-size: 1.2rem;
  }

  .filter-btn .filter-count {
    background: #e5e7eb;
    color: #6b7280;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 700;
    margin-left: 4px;
  }

  .filter-btn.active {
    border-color: #2563eb;
    background: #2563eb;
    color: white;
    box-shadow: 0 2px 4px rgba(37,99,235,0.3);
  }

  .filter-btn.active .filter-count {
    background: rgba(255,255,255,0.3);
    color: white;
  }

  .filter-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  .filter-btn:active {
    transform: translateY(0);
  }

  /* Sub-Filter Panel */
  .subfilter-panel {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
    border-bottom: 1px solid #e5e7eb;
  }

  .subfilter-panel.open {
    max-height: 200px;
  }

  .subfilter-checkbox {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s ease;
    user-select: none;
  }

  .subfilter-checkbox:hover {
    border-color: #2563eb;
    background: #eff6ff;
  }

  .subfilter-checkbox input[type="checkbox"] {
    cursor: pointer;
  }

  /* Map Buttons */
  .map-btn {
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    font-family: var(--font-body);
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
    flex: 1 1 auto;
    min-width: 140px;
  }

  .map-btn-primary {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    color: white;
    box-shadow: 0 2px 4px rgba(37,99,235,0.3);
  }

  .map-btn-primary:hover:not(:disabled) {
    box-shadow: 0 4px 12px rgba(37,99,235,0.4);
    transform: translateY(-2px);
  }

  .map-btn-secondary {
    background: white;
    color: #2563eb;
    border: 2px solid #2563eb;
    font-size: 0.85rem;
    padding: 8px 12px;
  }

  .map-btn-secondary:hover:not(:disabled) {
    background: #2563eb;
    color: white;
    transform: translateY(-1px);
  }

  .map-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    transform: none !important;
  }

  /* Leaflet Popup Customization */
  .leaflet-popup-content-wrapper {
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    padding: 0;
    overflow: hidden;
  }

  .leaflet-popup-content {
    margin: 0;
    font-family: var(--font-body);
    min-width: 200px;
  }

  .popup-header {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    color: white;
    padding: 12px 16px;
    font-weight: 700;
    font-size: 1rem;
  }

  .popup-body {
    padding: 12px 16px;
    line-height: 1.6;
  }

  .popup-body p {
    margin: 4px 0;
    font-size: 0.9rem;
  }

  .popup-actions {
    padding: 12px 16px;
    background: #f9fafb;
    border-top: 1px solid #e5e7eb;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .popup-btn {
    flex: 1;
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    display: inline-block;
    text-align: center;
    min-width: 100px;
  }

  .popup-btn-primary {
    background: #2563eb;
    color: white;
  }

  .popup-btn-primary:hover {
    background: #1d4ed8;
    transform: translateY(-1px);
  }

  .popup-btn-secondary {
    background: white;
    color: #2563eb;
    border: 1px solid #2563eb;
  }

  .popup-btn-secondary:hover {
    background: #eff6ff;
  }

  /* Marker Cluster Customization */
  .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large {
    background: rgba(37, 99, 235, 0.6);
  }

  .marker-cluster-small div, .marker-cluster-medium div, .marker-cluster-large div {
    background: rgba(37, 99, 235, 0.8);
    color: white;
    font-weight: 700;
  }

  /* Mobile Optimization */
  @media (max-width: 768px) {
    #unified-map {
      height: 400px;
    }

    .filter-btn {
      font-size: 0.85rem;
      padding: 8px 12px;
      min-width: 110px;
    }

    .filter-btn .filter-icon {
      font-size: 1rem;
    }

    .map-btn {
      font-size: 0.85rem;
      padding: 8px 12px;
      min-width: 110px;
    }

    .subfilter-checkbox {
      font-size: 0.8rem;
      padding: 4px 8px;
    }

    .popup-header {
      font-size: 0.9rem;
      padding: 10px 12px;
    }

    .popup-body p {
      font-size: 0.85rem;
    }

    .popup-btn {
      font-size: 0.8rem;
      padding: 6px 10px;
      min-width: 80px;
    }
  }

  @media (max-width: 480px) {
    #unified-map {
      height: 350px;
    }

    .filter-btn, .map-btn {
      flex: 1 1 100%;
      max-width: none;
    }

    .popup-actions {
      flex-direction: column;
    }

    .popup-btn {
      width: 100%;
    }
  }
</style>

<!-- Script -->
<script>
(function() {
  'use strict';

  // Configuration
  const CONFIG = {
    dataPaths: {
      wc: 'data/wc.geojson',
      gastro: 'data/gastronomie.geojson',
      parking: 'data/parking.geojson',
      oepnv: 'data/oepnv.geojson'
    },
    defaultCenter: [52.400, 13.085], // Between Park Babelsberg and Neuer Garten
    defaultZoom: 14,
    maxZoom: 19,
    tileLayer: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
    tileAttribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    clusterOptions: {
      maxClusterRadius: 60,
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: false,
      zoomToBoundsOnClick: true
    }
  };

  // Color schemes
  const COLORS = {
    wc: { public: '#10b981', customers: '#f59e0b', paid: '#3b82f6' },
    gastro: {
      restaurant: '#dc2626', cafe: '#92400e', fast_food: '#f59e0b',
      bar: '#7c3aed', pub: '#7c3aed', ice_cream: '#ec4899', biergarten: '#10b981'
    },
    parking: {
      bicycle_parking: '#10b981', public_free: '#3b82f6', public_paid: '#f59e0b',
      private: '#6b7280', 'multi-storey': '#1e3a8a'
    }
  };

  // State
  let map = null;
  let userPos = null;
  let userMarker = null;
  let clusters = {
    wc: L.markerClusterGroup(CONFIG.clusterOptions),
    gastro: L.markerClusterGroup(CONFIG.clusterOptions),
    parking: L.markerClusterGroup(CONFIG.clusterOptions),
    oepnv: L.markerClusterGroup(CONFIG.clusterOptions)
  };
  let data = { wc: [], gastro: [], parking: [], oepnv: [] };
  let activeFilters = { wc: true, gastro: true, parking: false, oepnv: false };
  let gastroSubFilters = {
    restaurant: true, cafe: true, fast_food: true,
    bar: true, pub: true, ice_cream: true, biergarten: true
  };

  // DOM Elements
  const btnLocate = document.getElementById('btn-locate');
  const btnNearestWC = document.getElementById('btn-nearest-wc');
  const btnNearestGastro = document.getElementById('btn-nearest-gastro');
  const btnNearestParking = document.getElementById('btn-nearest-parking');
  const distanceInfo = document.getElementById('distance-info');
  const filterButtons = document.querySelectorAll('.filter-btn');
  const gastroSubfilter = document.getElementById('gastro-subfilter');
  const gastroSubCheckboxes = document.querySelectorAll('.subfilter-checkbox input[type="checkbox"]');

  // Initialize Map
  function initMap() {
    map = L.map('unified-map', {
      zoomControl: true,
      attributionControl: true
    });

    L.tileLayer(CONFIG.tileLayer, {
      maxZoom: CONFIG.maxZoom,
      attribution: CONFIG.tileAttribution
    }).addTo(map);

    map.setView(CONFIG.defaultCenter, CONFIG.defaultZoom);

    // Add active clusters to map
    clusters.wc.addTo(map);
    clusters.gastro.addTo(map);
    // parking cluster not added by default
  }

  // Load all data
  async function loadAllData() {
    try {
      const [wcData, gastroData, parkingData, oepnvData] = await Promise.all([
        fetch(CONFIG.dataPaths.wc).then(r => r.json()),
        fetch(CONFIG.dataPaths.gastro).then(r => r.json()),
        fetch(CONFIG.dataPaths.parking).then(r => r.json()),
        fetch(CONFIG.dataPaths.oepnv).then(r => r.json())
      ]);

      if (wcData.features) wcData.features.forEach(f => addWCMarker(f));
      if (gastroData.features) gastroData.features.forEach(f => addGastroMarker(f));
      if (parkingData.features) parkingData.features.forEach(f => addParkingMarker(f));
      if (oepnvData.features) oepnvData.features.forEach(f => addOEPNVMarker(f));

      updateCounts();

      // Fit map to WC + Gastro data (not parking)
      const bounds = [
        ...data.wc.map(d => [d.lat, d.lng]),
        ...data.gastro.map(d => [d.lat, d.lng])
      ];

      if (bounds.length > 0) {
        map.fitBounds(bounds, { padding: [50, 50], maxZoom: 15 });
      }

    } catch (error) {
      console.error('Fehler beim Laden der Daten:', error);
    }
  }

  // Add WC marker
  function addWCMarker(feature) {
    const [lng, lat] = feature.geometry.coordinates;
    const props = feature.properties || {};

    let color = COLORS.wc.public;
    if (props.access === 'customers') color = COLORS.wc.customers;
    else if (props.fee === 'yes') color = COLORS.wc.paid;

    const marker = createMarker([lat, lng], color, '🚻');
    const popup = createWCPopup(props, lat, lng);
    marker.bindPopup(popup);

    clusters.wc.addLayer(marker);
    data.wc.push({ lat, lng, props, type: 'wc' });
  }

  // Add Gastro marker
  function addGastroMarker(feature) {
    const [lng, lat] = feature.geometry.coordinates;
    const props = feature.properties || {};

    const color = COLORS.gastro[props.amenity] || '#6b7280';
    const icon = getGastroIcon(props.amenity);
    const marker = createMarker([lat, lng], color, icon);
    const popup = createGastroPopup(props, lat, lng);
    marker.bindPopup(popup);

    marker._amenityType = props.amenity; // Store for filtering
    clusters.gastro.addLayer(marker);
    data.gastro.push({ lat, lng, props, type: 'gastro', amenity: props.amenity });
  }

  // Add Parking marker
  function addParkingMarker(feature) {
    const [lng, lat] = feature.geometry.coordinates;
    const props = feature.properties || {};

    const category = getParkingCategory(props);
    const color = COLORS.parking[category] || '#3b82f6';
    const marker = createMarker([lat, lng], color, '🅿️');
    const popup = createParkingPopup(props, lat, lng);
    marker.bindPopup(popup);

    clusters.parking.addLayer(marker);
    data.parking.push({ lat, lng, props, type: 'parking', category });
  }

  // Add ÖPNV marker (Bus & Tram)
  function addOEPNVMarker(feature) {
    const [lng, lat] = feature.geometry.coordinates;
    const props = feature.properties || {};

    // Unified color for all ÖPNV (Bus & Tram together)
    const color = '#10b981'; // Green
    const marker = createMarker([lat, lng], color, '🚍');
    const popup = createOEPNVPopup(props, lat, lng);
    marker.bindPopup(popup);

    // Event: Load live data when popup opens
    marker.on('popupopen', async () => {
      const liveContainerId = `live-departures-${lat.toFixed(5)}-${lng.toFixed(5)}`.replace(/\./g, '_');
      const refreshBtnId = `btn-refresh-${lat.toFixed(5)}-${lng.toFixed(5)}`.replace(/\./g, '_');

      const container = document.getElementById(liveContainerId);
      if (!container) return;

      // Check if already loaded
      if (container.dataset.loaded) return;
      container.dataset.loaded = 'true';

      // Fetch and display live data
      await updatePopupWithLiveData(lat, lng, liveContainerId);

      // Refresh button handler
      const refreshBtn = document.getElementById(refreshBtnId);
      if (refreshBtn) {
        refreshBtn.addEventListener('click', async () => {
          refreshBtn.disabled = true;
          refreshBtn.textContent = '⏳ Lädt...';

          await updatePopupWithLiveData(lat, lng, liveContainerId);

          refreshBtn.disabled = false;
          refreshBtn.textContent = '🔄 Aktualisieren';
        });
      }
    });

    clusters.oepnv.addLayer(marker);
    data.oepnv.push({ lat, lng, props, type: 'oepnv' });
  }

  // Create marker
  function createMarker(latlng, color, emoji) {
    const icon = L.divIcon({
      className: 'custom-marker',
      html: `<div style="
        width: 32px;
        height: 32px;
        background: ${color};
        border: 3px solid white;
        border-radius: 50%;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
      ">${emoji}</div>`,
      iconSize: [32, 32],
      iconAnchor: [16, 16],
      popupAnchor: [0, -16]
    });

    return L.marker(latlng, { icon });
  }

  // Create WC Popup
  function createWCPopup(props, lat, lng) {
    const name = props.name || 'WC';
    const access = getWCAccessLabel(props);
    const fee = getWCFeeLabel(props);

    const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=walking`;

    return `
      <div class="popup-header">🚻 ${name}</div>
      <div class="popup-body">
        <p>${access}</p>
        <p>${fee}</p>
      </div>
      <div class="popup-actions">
        <a href="${mapsUrl}" target="_blank" rel="noopener" class="popup-btn popup-btn-primary">
          📍 Route (Maps)
        </a>
      </div>
    `;
  }

  // Create Gastro Popup
  function createGastroPopup(props, lat, lng) {
    const name = props.name || 'Gastronomie';
    const type = getGastroLabel(props.amenity);
    const cuisine = props.cuisine ? `🍴 ${props.cuisine}` : '';
    const outdoor = props.outdoor_seating === 'yes' ? '🌞 Außensitzplätze' : '';
    const hours = props.opening_hours ? `🕐 ${props.opening_hours}` : '';
    const website = props.website || props.contact_website || props['contact:website'] || '';

    const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=walking`;

    let buttons = `<a href="${mapsUrl}" target="_blank" rel="noopener" class="popup-btn popup-btn-primary">📍 Route</a>`;
    if (website) {
      buttons += `<a href="${website}" target="_blank" rel="noopener" class="popup-btn popup-btn-secondary">🌐 Website</a>`;
    }

    return `
      <div class="popup-header">${name}</div>
      <div class="popup-body">
        <p>${type}</p>
        ${cuisine ? `<p>${cuisine}</p>` : ''}
        ${outdoor ? `<p>${outdoor}</p>` : ''}
        ${hours ? `<p>${hours}</p>` : ''}
      </div>
      <div class="popup-actions">
        ${buttons}
      </div>
    `;
  }

  // Create Parking Popup
  function createParkingPopup(props, lat, lng) {
    const name = props.name || 'Parkplatz';
    const type = props.amenity === 'bicycle_parking' ? '🚲 Fahrradparkplatz' : '🅿️ Auto-Parkplatz';
    const capacity = props.capacity ? `🚗 ${props.capacity} Plätze` : '';
    const fee = props.fee === 'yes' ? '💰 Kostenpflichtig' : props.fee === 'no' ? '✓ Kostenlos' : '';
    const access = props.access === 'private' ? '🔒 Privat' : props.access === 'customers' ? '🔒 Nur Kunden' : '';

    const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`;

    return `
      <div class="popup-header">${name}</div>
      <div class="popup-body">
        <p>${type}</p>
        ${capacity ? `<p>${capacity}</p>` : ''}
        ${fee ? `<p>${fee}</p>` : ''}
        ${access ? `<p>${access}</p>` : ''}
      </div>
      <div class="popup-actions">
        <a href="${mapsUrl}" target="_blank" rel="noopener" class="popup-btn popup-btn-primary">
          📍 Route (Auto)
        </a>
      </div>
    `;
  }

  // Create ÖPNV Popup (Phase 2: With Live-Departures)
  function createOEPNVPopup(props, lat, lng) {
    const name = props.name || 'Haltestelle';
    const ref = props.ref ? `#${props.ref}` : '';
    const isBus = props.bus === true || props.bus === 'yes';
    const isTram = props.tram === true || props.tram === 'yes';

    let types = [];
    if (isBus) types.push('🚌 Bus');
    if (isTram) types.push('🚊 Tram');
    const typeLabel = types.length > 0 ? types.join(' · ') : '🚍 ÖPNV';

    const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=walking`;
    const vbbUrl = `https://www.vbb.de/fahrplan/?origin=${lat},${lng}`;

    // Unique IDs for this popup
    const liveContainerId = `live-departures-${lat.toFixed(5)}-${lng.toFixed(5)}`.replace(/\./g, '_');
    const refreshBtnId = `btn-refresh-${lat.toFixed(5)}-${lng.toFixed(5)}`.replace(/\./g, '_');

    return `
      <div class="popup-header">
        🚍 ${name} ${ref}
      </div>
      <div class="popup-body">
        <p style="margin-bottom:8px;">${typeLabel}</p>
        <div id="${liveContainerId}" style="min-height:40px;">
          <p style="color:#6b7280;font-size:0.9rem;">⏳ Lade Fahrplandaten...</p>
        </div>
      </div>
      <div class="popup-actions">
        <button id="${refreshBtnId}" class="popup-btn popup-btn-primary" style="cursor:pointer;">
          🔄 Aktualisieren
        </button>
        <a href="${vbbUrl}" target="_blank" rel="noopener" class="popup-btn popup-btn-secondary">
          📱 VBB-App
        </a>
        <a href="${mapsUrl}" target="_blank" rel="noopener" class="popup-btn popup-btn-secondary">
          📍 Route
        </a>
      </div>
    `;
  }

  // ==========================================
  // PHASE 2: VBB Live-Fahrplandaten API
  // ==========================================

  // Cache for live departures (60s TTL)
  const departuresCache = new Map();
  const CACHE_TTL = 60000; // 60 seconds

  // Fetch live departures from VBB API
  async function fetchLiveDepartures(lat, lng) {
    const cacheKey = `${lat},${lng}`;
    const cached = departuresCache.get(cacheKey);

    // Return cached data if still fresh
    if (cached && (Date.now() - cached.timestamp < CACHE_TTL)) {
      console.log('VBB: Using cached data');
      return cached.data;
    }

    try {
      // 1. Find nearest stop
      const nearbyUrl = `https://v6.vbb.transport.rest/locations/nearby?latitude=${lat}&longitude=${lng}&results=1&poi=false&distance=150`;
      const nearbyRes = await fetch(nearbyUrl);

      if (!nearbyRes.ok) {
        throw new Error(`Nearby API failed: HTTP ${nearbyRes.status}`);
      }

      const nearbyData = await nearbyRes.json();

      if (!nearbyData || nearbyData.length === 0) {
        console.warn('VBB: No stop found nearby');
        return null;
      }

      const stop = nearbyData[0];
      console.log('VBB: Found stop', stop.name, stop.id);

      // 2. Get departures
      const depsUrl = `https://v6.vbb.transport.rest/stops/${stop.id}/departures?duration=60&results=10`;
      const depsRes = await fetch(depsUrl);

      if (!depsRes.ok) {
        throw new Error(`Departures API failed: HTTP ${depsRes.status}`);
      }

      const depsData = await depsRes.json();

      const result = {
        stopId: stop.id,
        stopName: stop.name,
        departures: depsData.departures || []
      };

      // Cache the result
      departuresCache.set(cacheKey, {
        data: result,
        timestamp: Date.now()
      });

      console.log('VBB: Fetched', result.departures.length, 'departures');
      return result;

    } catch (error) {
      console.error('VBB API Error:', error);
      return null;
    }
  }

  // Format departure time (relative: "3 Min" or absolute: "14:35")
  function formatDepartureTime(when) {
    const now = new Date();
    const depTime = new Date(when);
    const diffMs = depTime - now;
    const diffMin = Math.round(diffMs / 60000);

    if (diffMin < 0) return '<span style="color:#6b7280;">Abgefahren</span>';
    if (diffMin === 0) return '<span style="color:#ef4444;font-weight:700;">Jetzt</span>';
    if (diffMin <= 20) return `<span style="font-weight:700;">${diffMin} Min</span>`;

    return depTime.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
  }

  // Render departures HTML
  function renderDepartures(departures) {
    if (!departures || departures.length === 0) {
      return '<p style="color:#6b7280;font-size:0.9rem;padding:8px 0;">Keine Abfahrten in den nächsten 60 Minuten.</p>';
    }

    const items = departures.slice(0, 6).map(dep => {
      const lineName = dep.line?.name || dep.line?.id || '?';
      const direction = dep.direction || 'Unbekannt';
      const when = dep.when || dep.plannedWhen;
      const delay = dep.delay || 0;
      const timeLabel = formatDepartureTime(when);

      let delayLabel = '';
      if (delay > 0) {
        delayLabel = `<span style="color:#ef4444;font-size:0.75rem;font-weight:700;margin-left:4px;">+${delay}'</span>`;
      }

      const isTram = dep.line?.product === 'tram' || dep.line?.mode === 'train';
      const lineColor = isTram ? '#3b82f6' : '#f59e0b';
      const lineIcon = isTram ? '🚊' : '🚌';

      return `
        <div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid #e5e7eb;">
          <span style="background:${lineColor};color:white;padding:3px 8px;border-radius:6px;font-size:0.75rem;font-weight:700;min-width:55px;text-align:center;display:flex;align-items:center;justify-content:center;gap:4px;">
            ${lineIcon} ${lineName}
          </span>
          <span style="flex:1;font-size:0.85rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:#374151;">
            ${direction}
          </span>
          <span style="font-size:0.9rem;white-space:nowrap;">
            ${timeLabel}${delayLabel}
          </span>
        </div>
      `;
    }).join('');

    return `
      <div style="margin-top:8px;">
        <p style="font-weight:600;margin-bottom:6px;font-size:0.95rem;">Nächste Abfahrten:</p>
        <div style="max-height:200px;overflow-y:auto;">
          ${items}
        </div>
      </div>
    `;
  }

  // Update popup with live departures
  async function updatePopupWithLiveData(lat, lng, containerId) {
    const liveContainerId = containerId || `live-departures-${lat.toFixed(5)}-${lng.toFixed(5)}`.replace(/\./g, '_');
    const container = document.getElementById(liveContainerId);
    if (!container) return;

    // Show loading
    container.innerHTML = '<p style="color:#6b7280;font-size:0.9rem;">⏳ Lade Fahrplandaten...</p>';

    // Fetch data
    const liveData = await fetchLiveDepartures(lat, lng);

    if (!container) return; // Popup might be closed

    if (liveData && liveData.departures) {
      const now = new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
      container.innerHTML = renderDepartures(liveData.departures) +
        `<p style="color:#6b7280;font-size:0.75rem;margin-top:8px;">🕐 Aktualisiert: ${now}</p>`;
    } else {
      container.innerHTML = `
        <div style="padding:12px;background:#fef2f2;border:1px solid #fecaca;border-radius:6px;margin-top:8px;">
          <p style="color:#dc2626;font-size:0.85rem;margin:0;">
            ⚠️ Live-Daten vorübergehend nicht verfügbar
          </p>
          <p style="color:#6b7280;font-size:0.8rem;margin:4px 0 0;">
            Bitte nutze den VBB-Fahrplan-Link unten.
          </p>
        </div>
      `;
    }
  }

  // Helper functions
  function getWCAccessLabel(props) {
    const labels = {
      'public': '🟢 Öffentlich', 'yes': '🟢 Öffentlich',
      'permissive': '🟢 Zugänglich', 'customers': '🟡 Nur Kunden', 'private': '🔴 Privat'
    };
    return labels[props.access] || '🟢 Zugänglich';
  }

  function getWCFeeLabel(props) {
    if (props.fee === 'yes') return '💰 Kostenpflichtig';
    if (props.fee === 'no') return '✓ Kostenlos';
    return '❓ Kosten unbekannt';
  }

  function getGastroIcon(amenity) {
    const icons = {
      restaurant: '🍽️', cafe: '☕', fast_food: '🍔',
      bar: '🍺', pub: '🍺', ice_cream: '🍦', biergarten: '🌳'
    };
    return icons[amenity] || '🍽️';
  }

  function getGastroLabel(amenity) {
    const labels = {
      restaurant: '🍽️ Restaurant', cafe: '☕ Café', fast_food: '🍔 Imbiss',
      bar: '🍺 Bar', pub: '🍺 Pub', ice_cream: '🍦 Eiscafé', biergarten: '🌳 Biergarten'
    };
    return labels[amenity] || amenity;
  }

  function getParkingCategory(props) {
    if (props.amenity === 'bicycle_parking') return 'bicycle_parking';
    if (props.parking === 'multi-storey') return 'multi-storey';
    if (props.access === 'private' || props.access === 'customers') return 'private';
    if (props.fee === 'yes') return 'public_paid';
    return 'public_free';
  }

  // Update counts
  function updateCounts() {
    document.getElementById('count-wc').textContent = data.wc.length;
    document.getElementById('count-gastro').textContent = data.gastro.length;
    document.getElementById('count-parking').textContent = data.parking.length;
    document.getElementById('count-oepnv').textContent = data.oepnv.length;
  }

  // Main filter toggle
  filterButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const layer = btn.dataset.layer;
      const isActive = btn.classList.contains('active');

      if (isActive) {
        btn.classList.remove('active');
        btn.setAttribute('aria-pressed', 'false');
        map.removeLayer(clusters[layer]);
        activeFilters[layer] = false;

        // Hide gastro subfilter if gastro disabled
        if (layer === 'gastro') {
          gastroSubfilter.classList.remove('open');
        }

        // Hide parking button if parking disabled
        if (layer === 'parking') {
          btnNearestParking.style.display = 'none';
        }
      } else {
        btn.classList.add('active');
        btn.setAttribute('aria-pressed', 'true');
        clusters[layer].addTo(map);
        activeFilters[layer] = true;

        // Show gastro subfilter if gastro enabled
        if (layer === 'gastro') {
          gastroSubfilter.classList.add('open');
        }

        // Show parking button if parking enabled
        if (layer === 'parking') {
          btnNearestParking.style.display = 'inline-block';
        }
      }

      updateDistanceInfo();
    });
  });

  // Gastro sub-filter
  gastroSubCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', () => {
      const amenity = checkbox.dataset.amenity;
      gastroSubFilters[amenity] = checkbox.checked;
      applyGastroSubFilters();
      updateDistanceInfo();
    });
  });

  function applyGastroSubFilters() {
    clusters.gastro.clearLayers();

    data.gastro.forEach(item => {
      if (gastroSubFilters[item.amenity]) {
        const color = COLORS.gastro[item.amenity] || '#6b7280';
        const icon = getGastroIcon(item.amenity);
        const marker = createMarker([item.lat, item.lng], color, icon);
        const popup = createGastroPopup(item.props, item.lat, item.lng);
        marker.bindPopup(popup);
        clusters.gastro.addLayer(marker);
      }
    });
  }

  // Haversine distance
  function haversine(pos1, pos2) {
    const R = 6371000;
    const toRad = x => x * Math.PI / 180;
    const dLat = toRad(pos2.lat - pos1.lat);
    const dLng = toRad(pos2.lng - pos1.lng);
    const lat1 = toRad(pos1.lat);
    const lat2 = toRad(pos2.lat);
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1) * Math.cos(lat2) *
              Math.sin(dLng/2) * Math.sin(dLng/2);
    return 2 * R * Math.asin(Math.sqrt(a));
  }

  // Find nearest
  function findNearest(type) {
    if (!userPos || !activeFilters[type]) return null;

    let searchList = data[type];

    // Apply gastro sub-filters
    if (type === 'gastro') {
      searchList = searchList.filter(item => gastroSubFilters[item.amenity]);
    }

    // Prioritize car parking
    if (type === 'parking') {
      const carParking = searchList.filter(p => p.props.amenity !== 'bicycle_parking');
      if (carParking.length > 0) searchList = carParking;
    }

    if (searchList.length === 0) return null;

    let nearest = null;
    let minDistance = Infinity;

    searchList.forEach(loc => {
      const distance = haversine(
        { lat: userPos.lat, lng: userPos.lng },
        { lat: loc.lat, lng: loc.lng }
      );

      if (distance < minDistance) {
        minDistance = distance;
        nearest = { ...loc, distance };
      }
    });

    return nearest;
  }

  // Format distance
  function formatDistance(meters) {
    if (meters < 1000) return `${Math.round(meters)} m`;
    return `${(meters / 1000).toFixed(1)} km`;
  }

  // Update distance info
  function updateDistanceInfo() {
    if (!userPos) return;

    const distances = [];

    if (activeFilters.wc) {
      const nearest = findNearest('wc');
      if (nearest) distances.push(`WC: ${formatDistance(nearest.distance)}`);
    }

    if (activeFilters.gastro) {
      const nearest = findNearest('gastro');
      if (nearest) distances.push(`Restaurant: ${formatDistance(nearest.distance)}`);
    }

    if (activeFilters.parking) {
      const nearest = findNearest('parking');
      if (nearest) distances.push(`Parkplatz: ${formatDistance(nearest.distance)}`);
    }

    if (activeFilters.oepnv) {
      const nearest = findNearest('oepnv');
      if (nearest) distances.push(`Haltestelle: ${formatDistance(nearest.distance)}`);
    }

    distanceInfo.textContent = distances.length > 0
      ? `Nächste: ${distances.join(' · ')}`
      : '';
  }

  // Locate user
  function locateUser() {
    if (!navigator.geolocation) {
      alert('Geolocation wird von deinem Browser nicht unterstützt.');
      return;
    }

    btnLocate.disabled = true;
    btnLocate.textContent = '⏳ Ermittle...';

    navigator.geolocation.getCurrentPosition(
      position => {
        userPos = { lat: position.coords.latitude, lng: position.coords.longitude };

        if (userMarker) map.removeLayer(userMarker);

        userMarker = L.circleMarker([userPos.lat, userPos.lng], {
          radius: 10,
          fillColor: '#ef4444',
          color: '#fff',
          weight: 3,
          opacity: 1,
          fillOpacity: 0.9
        }).addTo(map);

        userMarker.bindPopup('<strong>📍 Dein Standort</strong>').openPopup();

        map.setView([userPos.lat, userPos.lng], 16);

        btnNearestWC.disabled = false;
        btnNearestGastro.disabled = false;
        if (activeFilters.parking) btnNearestParking.disabled = false;
        btnLocate.textContent = '✓ Standort aktiv';

        updateDistanceInfo();
      },
      error => {
        btnLocate.disabled = false;
        btnLocate.textContent = '📍 Standort nutzen';

        let message = 'Standortzugriff fehlgeschlagen. ';
        switch(error.code) {
          case error.PERMISSION_DENIED:
            message += 'Bitte erlaube Standortzugriff.';
            break;
          case error.POSITION_UNAVAILABLE:
            message += 'Standort nicht verfügbar.';
            break;
          case error.TIMEOUT:
            message += 'Zeitüberschreitung.';
            break;
        }
        alert(message);
      },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
  }

  // Navigate to nearest
  function navigateToNearest(type) {
    if (!userPos) return;

    const nearest = findNearest(type);
    if (!nearest) {
      const labels = { wc: 'WC', gastro: 'Restaurant', parking: 'Parkplatz' };
      alert(`Kein${type === 'gastro' ? '' : 'e'} ${labels[type]} gefunden.`);
      return;
    }

    const origin = `${userPos.lat},${userPos.lng}`;
    const destination = `${nearest.lat},${nearest.lng}`;
    const travelMode = type === 'parking' ? 'driving' : 'walking';

    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

    let url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&travelmode=${travelMode}`;

    if (isMobile) {
      if (isIOS) {
        const dirFlag = type === 'parking' ? 'd' : 'w';
        window.location.href = `maps://maps.apple.com/?saddr=${origin}&daddr=${destination}&dirflg=${dirFlag}`;
        setTimeout(() => { window.location.href = url; }, 500);
      } else {
        window.location.href = url;
      }
    } else {
      window.open(url, '_blank', 'noopener,noreferrer');
    }
  }

  // Event Listeners
  btnLocate.addEventListener('click', locateUser);
  btnNearestWC.addEventListener('click', () => navigateToNearest('wc'));
  btnNearestGastro.addEventListener('click', () => navigateToNearest('gastro'));
  btnNearestParking.addEventListener('click', () => navigateToNearest('parking'));

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      initMap();
      loadAllData();
    });
  } else {
    initMap();
    loadAllData();
  }
})();
</script>

<!-- Footer -->
<footer style="
  margin-top: 80px;
  padding: 40px 20px;
  background: linear-gradient(180deg, transparent 0%, var(--bg-secondary) 20%);
  border-top: 1px solid var(--border);
">
  <div style="max-width: 1200px; margin: 0 auto; text-align: center;">
    <p style="color: var(--text-muted); font-size: 0.9rem; line-height: 1.8; margin-bottom: 16px;">
      © 2025 Park Babelsberg Info · Alle Rechte vorbehalten
    </p>
    <p style="color: var(--text-secondary); font-size: 0.85rem;">
      <a href="impressum.html" style="color: var(--accent-primary); text-decoration: none; margin: 0 12px; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">Impressum</a>
      ·
      <a href="datenschutz.html" style="color: var(--accent-primary); text-decoration: none; margin: 0 12px; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">Datenschutz</a>
      ·
      <a href="index.html#bereiche" style="color: var(--accent-primary); text-decoration: none; margin: 0 12px; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">Übersicht</a>
    </p>
    <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 24px;">
      Kartendaten © <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener noreferrer" style="color: var(--accent-primary); text-decoration: none;">OpenStreetMap</a> contributors
    </p>
  </div>
</footer>



</body>
</html>
